@page "/"

<div class="cast-container">
    <div class="cast-card">
        <h3 class="cast-card-title">What civic defect would you like to cast..</h3>

        <div class="form-group">
            <input type="text" class="cast-input-2" placeholder="Enter a title..." @bind="_newHorror.Title" @onfocus="() => _isExpanded = true" />
        </div>

        @if (_isExpanded)
        {
            <div class="form-group">
                <textarea class="cast-input-2" placeholder="Describe the defect and add media..." @bind="_newHorror.Description"></textarea>
            </div>

            <div class="form-group">
                <InputFile OnChange="HandleFileSelected" multiple accept="image/*,video/*" MaxFileSize="10485760" /> 
            </div>

            <div class="form-group">
                <label>
                    <input type="radio" name="Killer Roads" Value="Killer Roads"  />
                    Killer Roads
                </label>
                <label>
                    <input type="radio" name="Bad Buildings" Value="Bad Buildings" />
                    Bad Buildings
                </label>
                <label>
                    <input type="radio" name="Others" Value="Others"/>
                    Others
                </label>
            </div>

            @if (_newHorror.Previews.Count > 0)
            {
                <div class="preview-area">
                    @foreach (var preview in _newHorror.Previews)
                    {
                        if (preview.IsVideo)
                        {
                            <video src="@preview.Url" controls width="150" style="margin-right:10px;"></video>
                        }
                        else
                        {
                            <img src="@preview.Url" alt="preview" style="width:150px; height:auto; margin-right:10px;" />                        }
                        }
                </div>
            }

            <div class="cast-actions">
                <button class="cast-btn" @onclick="SubmitHorror" disabled="@string.IsNullOrWhiteSpace(_newHorror.Title)">
                    Cast Am Now ğŸš¨
                </button>
            </div>
        }
    </div>

    <div class="cast-feed">
        @foreach (var cast in _casts)
        {
            <div class="cast-item">
                <div class="cast-user">@cast.User</div>
                <div class="cast-text">@cast.Text</div>
                <div class="cast-time">@cast.TimePosted.ToString("MMM d, h:mm tt")</div>
            </div>
        }
    </div>
</div>

@code {
    //private string? _newCast;
    private bool _isExpanded;
    private string _selectedCategory = "";
    private List<Cast> _casts = [];
    [CascadingParameter] public IModalService? Modal { get; set; }
    
    private HorrorSubmission _newHorror = new();

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            _newHorror.Attachments.Add(file.Name);

            await using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);

            var buffer = new byte[file.Size];
            await stream.ReadAsync(buffer);

            var base64 = Convert.ToBase64String(buffer);
            var mimeType = file.ContentType;

            var url = $"data:{mimeType};base64,{base64}";
            bool isVideo = mimeType.StartsWith("video/");
            _newHorror.Previews.Add(new PreviewItem { Url = url, IsVideo = isVideo });
        }
    }
    
    private void SubmitHorror()
    {
        _newHorror.Category = _selectedCategory;

        Console.WriteLine($"Title: {_newHorror.Title}");
        Console.WriteLine($"Description: {_newHorror.Description}");
        Console.WriteLine($"Category: {_newHorror.Category}");
        Console.WriteLine($"Files: {string.Join(", ", _newHorror.Attachments)}");
        Console.WriteLine($"Previews: {string.Join(", ", _newHorror.Previews.Select(p => p.Url))}");

        _newHorror = new HorrorSubmission();
        _selectedCategory = "";
        _isExpanded = false;
    }


    protected override void OnInitialized()
    {
        // Dummy seed data
        _casts =
        [
        new Cast { User = "ğŸ‘¤ Ada", Text = "NEPA don take light again ğŸ˜¡", TimePosted = DateTime.Now.AddMinutes(-5) },
new Cast { User = "ğŸ‘¤ Bayo", Text = "Fuel price don high! ğŸš—â›½", TimePosted = DateTime.Now.AddHours(-1) },
new Cast { User = "ğŸ‘¤ Chika", Text = "Who get update for better job abeg? ğŸ™", TimePosted = DateTime.Now.AddHours(-3) },
new Cast { User = "ğŸ‘¤ Damilola", Text = "Traffic for 3rd Mainland Bridge na wah o ğŸš¦", TimePosted =
DateTime.Now.AddDays(-1) }
        ];
    }
    
    private class Cast
    {
        public string User { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
        public DateTime TimePosted { get; set; }
    }
    
    public class HorrorSubmission
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
        public List<string> Attachments { get; set; } = new();
        public List<PreviewItem> Previews { get; set; } = new();
    }

    public class PreviewItem
    {
        public string Url { get; set; } = "";
        public bool IsVideo { get; set; }
    }
}